<?php// Autor: 		Cesar Cuenca// Fecha:		25/FEB/213// Objetivo:	Implementacion validaciones lado del servidor// Version:		1.0//___________________________________________________________@session_start();$login=$_SESSION['login'];require('../conexion.php');require('../funciones.php');require ('../lib/mailer.php');$id_orden=$_POST['id_orden'];$comp=$_POST['comp'];$crit=$_POST['crit'];$prio=$_POST['prio'];//$fecha_sol=$_POST['fecha_sol'];$diagnos=$_POST['diagnos'];$area=$_POST['area'];$pru1=$_POST['pru1'];$pru2=$_POST['pru2'];$pru3=$_POST['pru3'];$sw_escal=$_POST['sw_escal'];$automatico=$_POST['sw_automatico'];$id_orden=_clean($id_orden);$comp=_clean($comp);$crit=_clean($crit);$prio=_clean($prio);//$asig=_clean($asig);$fecha_sol=_clean($fecha_sol);$diagnos=_clean($diagnos);$area=_clean($area);$pru1=_clean($pru1);$pru2=_clean($pru2);$pru3=_clean($pru3);$sw_escal=_clean($sw_escal);$id_orden=SanitizeString($id_orden);$comp=SanitizeString($comp);$crit=SanitizeString($crit);$prio=SanitizeString($prio);//$asig=SanitizeString($asig);$fecha_sol=SanitizeString($fecha_sol);$diagnos=SanitizeString($diagnos);$area=SanitizeString($area);$pru1=SanitizeString($pru1);$pru2=SanitizeString($pru2);$pru3=SanitizeString($pru3);$sw_escal=SanitizeString($sw_escal);$id_orden=normaliza($id_orden);$comp=normaliza($comp);$crit=normaliza($crit);$prio=normaliza($prio);//$asig=normaliza($asig);$fecha_sol=normaliza($fecha_sol);$diagnos=normaliza($diagnos);$area=normaliza($area);$pru1=normaliza($pru1);$pru2=normaliza($pru2);$pru3=normaliza($pru3);$sw_escal=normaliza($sw_escal);$escal='';$fecha_escal='0000-00-00';if($automatico==='true'){    $asig='|ialvarez';}elseif ($automatico==='false'){    $asig=$_POST['asig'];    }if ($sw_escal=='true'){	$escal=$_POST['escal'];	$escal=_clean($escal);	$escal=SanitizeString($escal);	$fecha_escal=$_POST['fecha_escal'];	$fecha_escal=_clean($fecha_escal);	$fecha_escal=SanitizeString($fecha_escal);	$fecha_escal=substr($fecha_escal,6,4).'-'.substr($fecha_escal,3,2).'-'.substr($fecha_escal,0,2);}$fecha_sol=substr($fecha_sol,6,4).'-'.substr($fecha_sol,3,2).'-'.substr($fecha_sol,0,2);$area_1=$pru1.'|'.$pru2.'|'.$pru3;/* CONSULTA DESCRIPCION DE NIVELES */$sql="SELECT n_indice, s_desc FROM t_asig_complejidad WHERE n_cod_complejidad=$comp";$recordset=mysql_query($sql);$fila=mysql_fetch_array($recordset);$comp_desc=$fila['n_indice'].'-'.$fila['s_desc'];$sql="SELECT n_indice, s_desc FROM t_asig_criticidad WHERE n_cod_criticidad=$crit";$recordset=mysql_query($sql);$fila=mysql_fetch_array($recordset);$crit_desc=$fila['n_indice'].'-'.$fila['s_desc'];$sql="SELECT n_indice, s_desc FROM t_asig_prioridad WHERE n_cod_prioridad=$prio";$recordset=mysql_query($sql);$fila=mysql_fetch_array($recordset);$prio_desc=$fila['n_indice'].'-'.$fila['s_desc'];/* FIN CONSULTA DESCRIPCION DE NIVELES*/$asig_array=explode('|',$asig);$emails = array();$flag_mail=0; // variable baander, para verificar errores en el envio de correos.$flag_insert=0; // variable bandera, para verificar estado de las inserciones (control de errores al insertar)for ($i=1;$i<=count($asig_array)-1;$i++){        if($automatico==='true'){//FALSE        $sql_obj='SELECT ordenes.id_orden, objetivos.id_objetivo, objetivos.objetivo, objetivos.resp1, objetivos.tiempo1,            objetivos.resp2,objetivos.tiempo2,objetivos.resp3,objetivos.tiempoestimado FROM objetivos INNER JOIN ordenes ON ordenes.objetivo = objetivos.id_objetivo            WHERE id_orden='.$id_orden;            $query=mysql_query($sql_obj);            $fila = mysql_fetch_array($query);            $responsable1='1';            $fecha=  date('Y-m-d');            $dia=$fila['tiempo1'];            $nuevafecha = strtotime ( '+'.$dia.' day' , strtotime ($fecha ) ) ;            $nuevafecha = date ( 'Y-m-d' , $nuevafecha );                     $sql="INSERT INTO asignacion (id_asig, id_orden, nivel_asig, criticidad_asig, prioridad_asig, asig, fecha_asig, hora_asig, fechaestsol_asig, reg_asig, diagnos, escal, fechasol_esc, area, area_1,automatico,resp1)                VALUES(null, $id_orden, $comp, $crit, $prio, '".$fila['resp1']."', '".date('Y-m-d')."', '".date('H:i:s')."', '".$nuevafecha."',  '$login', '$diagnos', '$escal', '$fecha_escal', '$area', '$area_1','1','$responsable1')";            //print_memusage($sql);            //exit;        }        else{//TRUE          $sql="INSERT INTO asignacion (id_asig, id_orden, nivel_asig, criticidad_asig, prioridad_asig, asig, fecha_asig, hora_asig, fechaestsol_asig, reg_asig, diagnos, escal, fechasol_esc, area, area_1)       		VALUES(null, $id_orden, $comp, $crit, $prio, '".$asig_array[$i]."', '".date('Y-m-d')."', '".date('H:i:s')."', '$fecha_sol', '$login', '$diagnos', '$escal', '$fecha_escal', '$area', '$area_1')";        }		if (!mysql_query($sql)){		$flag_insert++;	}	else{ // INSERCION CORRECTA		$recordset_mail=mysql_query("SELECT email FROM users WHERE login_usr='$asig_array[$i]'");		$fila_mail=mysql_fetch_array($recordset_mail);		$asunto='Asignacion de Orden de Trabajo Nro. '.$id_orden;		$mensaje='<table border="1">					<thead>						<tr>							<th colspan="2"><font size="3">NUEVA ASIGNACION - ORDEN DE TRABAJO NRO. '.$id_orden.'</font></th>						</tr>					</thead>					<tbody>						<tr>							<td>Asignado por:</td><td>'.$login.'</td>						</tr>						<tr>							<td>Diagn&oacute;stico:</td><td>'.$diagnos.'</td>						</tr>						<tr>							<td>Complejidad:</td><td>'.$comp_desc.'</td>						</tr>						<tr>							<td>Criticidad:</td><td>'.$crit_desc.'</td>						</tr>						<tr>							<td>Prioridad:</td><td>'.$prio_desc.'</td>						</tr>						<tr>							<td>Fecha estimada Soluci&oacute;n:</td><td>'.$fecha_sol.'</td>						</tr>						<tr>							<td>Area:</td><td>'.$area.'</td>						</tr>					</tbody>				</table>';				$temp=array($fila_mail['email'],$asig_array[$i]);				$header = "From: ". isset($nombre) . " <" . isset($email) . ">\r\nContent-type: text/html\r\n";				foreach($temp AS $a){					mail($a,$asunto, $mensaje,$header);				}				array_push($emails, $temp);	}}if ($flag_insert==0)echo 0;//echo $sql;else	echo $sql; //  Error al insertar?>